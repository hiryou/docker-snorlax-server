version: "3.2"

services:

  namenode:
    build: ./namenode
    image: snorlax/hadoop-namenode:master
    container_name: namenode
    #hostname: namenode.snorlax.local
    ports:
      - 9870:9870
      - 9000:9000
    volumes:
      - type: volume
        source: /home/hadoop/docker/volumes/hadoop_namenode
        target: /hadoop/dfs/name
      - type: bind
        source: /home/hadoop/docker/volumes/host_shared
        target: /host_shared
        read_only: true
    environment:
      - CLUSTER_NAME=test
    env_file:
      - ./hadoop.env

  datanode1:
    build: ./datanode
    image: snorlax/hadoop-datanode:master
    container_name: datanode1
    ports:
      - 9864:9864
    depends_on:
      - namenode
    volumes:
      - /home/hadoop/docker/volumes/hadoop_datanode1:/hadoop/dfs/data
    environment:
      SERVICE_PRECONDITION: "namenode:9870"
    env_file:
      - ./hadoop.env

  snorlax-master:
    build: ./snorlax-master
    image: snorlax/snorlax-master:master
    container_name: snorlax-master
    env_file:
      - ./hadoop.env
      - ./hadoop-hive.env
    environment:
      HIVE_CORE_CONF_javax_jdo_option_ConnectionURL: "jdbc:postgresql://hive-metastore/metastore"
      #SERVICE_PRECONDITION: "hive-metastore:9083"
      SERVICE_PRECONDITION: "namenode:9870"
    ports:
      - "10000:10000"
    volumes:
      - type: bind
        source: /home/hadoop/docker/volumes/host_shared
        target: /host_shared

#  hive-metastore:
#    image: bde2020/hive:2.3.2-postgresql-metastore
#    container_name: hive-metastore
#    env_file:
#      - ./hadoop.env
#      - ./hadoop-hive.env
#    command: /opt/hive/bin/hive --service metastore
#    environment:
#      SERVICE_PRECONDITION: "hive-metastore-postgresql:5432"
#    ports:
#      - "9083:9083"
